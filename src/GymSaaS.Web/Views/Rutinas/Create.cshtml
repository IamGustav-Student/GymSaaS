@model GymSaaS.Application.Rutinas.Commands.CreateRutina.CreateRutinaCommand

@{
    ViewData["Title"] = "Nueva Rutina";
    var ejerciciosList = ViewData["ListaEjercicios"] as IEnumerable<GymSaaS.Application.Ejercicios.Queries.GetEjercicios.EjercicioDto>;
}

<form asp-action="Create" id="formRutina">
    <div class="d-flex justify-content-between align-items-center mb-4 fade-in">
        <div>
            <h2 class="fw-bold text-white mb-0">Crear Rutina</h2>
            <p class="text-muted small">Asigna ejercicios y cargas a un alumno.</p>
        </div>
        <button type="submit" class="btn btn-primary shadow-sm">
            <i class="bi bi-save me-2"></i> Guardar
        </button>
    </div>

    <div class="row fade-in-up">
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-lg h-100">
                <div class="card-header bg-transparent py-3">
                    <i class="bi bi-person-badge text-primary me-2"></i> <span class="fw-bold">Alumno</span>
                </div>
                <div class="card-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3 small"></div>

                    <div class="mb-3">
                        <label asp-for="Nombre" class="form-label">NOMBRE RUTINA</label>
                        <input asp-for="Nombre" class="form-control bg-dark border-secondary text-white" placeholder="Ej: Full Body - Mes 1" />
                        <span asp-validation-for="Nombre" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">SELECCIONAR SOCIO</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text bg-dark border-secondary text-muted"><i class="bi bi-search"></i></span>
                            <input type="text" id="buscadorSocio" class="form-control bg-dark border-secondary text-white" placeholder="Buscar por nombre..." autocomplete="off">
                        </div>

                        <select asp-for="SocioId" id="selectSocio" class="form-select bg-dark border-secondary text-white" asp-items="ViewBag.ListaSocios" size="6">
                            <option value="">-- Seleccione Alumno --</option>
                        </select>
                        <span asp-validation-for="SocioId" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="FechaFin" class="form-label">VENCIMIENTO</label>
                        <input asp-for="FechaFin" class="form-control bg-dark border-secondary text-white" type="date" />
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-lg h-100">
                <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
                    <div><i class="bi bi-dumbbell text-primary me-2"></i> <span class="fw-bold">Ejercicios</span></div>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="agregarFila()">
                        <i class="bi bi-plus-lg me-1"></i> Agregar
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-dark text-white-50">
                                <tr>
                                    <th width="40%">Ejercicio</th>
                                    <th width="15%">Series</th>
                                    <th width="15%">Reps</th>
                                    <th width="20%">Carga/Nota</th>
                                    <th width="10%"></th>
                                </tr>
                            </thead>
                            <tbody id="tbodyEjercicios"></tbody>
                        </table>
                    </div>
                    <div id="emptyMessage" class="text-center py-5 text-muted">
                        <i class="bi bi-journal-plus fs-1 d-block mb-2 opacity-25"></i>
                        <p class="small">Sin ejercicios asignados</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // 1. Script de Búsqueda de Socio
        $(document).ready(function() {
            var $select = $('#selectSocio');
            var $options = $select.find('option');

            $('#buscadorSocio').on('keyup', function() {
                var term = $(this).val().toLowerCase();
                $select.empty();

                var $filtered = $options.filter(function() {
                    return $(this).text().toLowerCase().indexOf(term) > -1 || $(this).val() === "";
                });
                $select.append($filtered);
            });
        });

        // 2. Script de Tabla Dinámica
        const catalogo = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ejerciciosList));
        let count = 0;

        function agregarFila() {
            document.getElementById('emptyMessage').style.display = 'none';
            const tbody = document.getElementById('tbodyEjercicios');
            const row = document.createElement('tr');
            row.id = `fila_${count}`;

            // Generar opciones del select agrupadas
            let options = '<option value="">Elegir...</option>';
            let grupoActual = "";
            catalogo.forEach(e => {
                let g = e.GrupoMuscular || "General";
                if(g !== grupoActual) {
                    if(grupoActual !== "") options += '</optgroup>';
                    options += `<optgroup label="${g}">`;
                    grupoActual = g;
                }
                options += `<option value="${e.Id}">${e.Nombre}</option>`;
            });
            options += '</optgroup>';

            row.innerHTML = `
                <td><select name="Ejercicios[${count}].EjercicioId" class="form-select form-select-sm bg-dark border-secondary text-white" required>${options}</select></td>
                <td><input type="number" name="Ejercicios[${count}].Series" class="form-control form-control-sm bg-dark border-secondary text-white text-center" value="4"></td>
                <td><input type="number" name="Ejercicios[${count}].Repeticiones" class="form-control form-control-sm bg-dark border-secondary text-white text-center" value="10"></td>
                <td><input type="text" name="Ejercicios[${count}].PesoSugerido" class="form-control form-control-sm bg-dark border-secondary text-white" placeholder="Kg"></td>
                <td class="text-end"><button type="button" class="btn btn-link text-danger p-0" onclick="document.getElementById('fila_${count}').remove()"><i class="bi bi-trash"></i></button></td>
            `;
            tbody.appendChild(row);
            count++;
        }
    </script>
}