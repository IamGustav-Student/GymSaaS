@model GymSaaS.Application.Clases.Commands.ReservarClase.ReservarClaseCommand
@using GymSaaS.Application.Clases.Queries.GetClases

@{
    ViewData["Title"] = "Inscribir Alumno";
    Layout = "~/Views/Shared/_LayoutMD3.cshtml";

    var clase = ViewBag.ClaseInfo as ClaseDto;
    // Cálculo seguro del porcentaje para la barra de progreso
    var porcentaje = clase != null && clase.CupoMaximo > 0 ? (double)clase.CupoReservado / clase.CupoMaximo * 100 : 0;

    // Colores dinámicos para la barra según ocupación
    string progressClass = porcentaje >= 90 ? "bg-danger shadow-danger" : porcentaje >= 50 ? "bg-warning shadow-warning" : "bg-success shadow-success";
    string progressColor = porcentaje >= 90 ? "#ff2a2a" : porcentaje >= 50 ? "#ffa500" : "#0aff0a";
}

<form asp-action="Reservar">
    <input type="hidden" asp-for="ClaseId" />

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <a asp-action="Index" class="btn-md3-icon me-3 text-decoration-none">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h2 class="brand-font m-0 text-white">Inscribir</h2>
        </div>
        <button type="submit" class="btn-md3 btn-md3-primary">
            <i class="bi bi-check-lg me-2"></i> Confirmar
        </button>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="glass-panel h-100 position-relative overflow-hidden text-center p-4">
                <div style="position: absolute; top: -20%; left: -20%; width: 150%; height: 150%; background: radial-gradient(circle, rgba(0, 243, 255, 0.05) 0%, transparent 60%); pointer-events: none;"></div>

                <div class="rounded-circle bg-dark border border-info d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);">
                    <i class="bi bi-calendar2-event text-info fs-1"></i>
                </div>

                <h3 class="fw-bold text-white mb-1 brand-font">@clase?.Nombre</h3>
                <p class="text-secondary mb-4 small">@clase?.Instructor</p>

                <div class="d-flex justify-content-center gap-4 mb-4 border-top border-bottom border-secondary border-opacity-25 py-3">
                    <div>
                        <span class="d-block text-white fw-bold fs-5">@clase?.FechaHoraInicio.ToString("HH:mm")</span>
                        <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Horario</small>
                    </div>
                    <div class="vr bg-secondary opacity-50"></div>
                    <div>
                        <span class="d-block text-white fw-bold fs-5">@clase?.DuracionMinutos'</span>
                        <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Duración</small>
                    </div>
                </div>

                <div class="text-start">
                    <div class="d-flex justify-content-between mb-2 small">
                        <span class="text-secondary">Ocupación</span>
                        <span class="text-white fw-bold">@clase?.CupoReservado / @clase?.CupoMaximo</span>
                    </div>
                    <div class="progress bg-dark border border-secondary border-opacity-25" style="height: 8px;">
                        <div class="progress-bar @progressClass" role="progressbar" style="width: @porcentaje%; box-shadow: 0 0 10px @progressColor;"></div>
                    </div>
                    @if (clase?.CupoReservado >= clase?.CupoMaximo)
                    {
                        <div class="mt-3 text-danger fw-bold small">
                            <i class="bi bi-exclamation-triangle me-1"></i> CUPO COMPLETO
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="glass-panel h-100">
                <div class="d-flex align-items-center mb-4 pb-3 border-bottom border-secondary border-opacity-25">
                    <i class="bi bi-person-check-fill text-white fs-5 me-2"></i>
                    <span class="fw-bold text-uppercase text-white" style="letter-spacing: 1px;">Seleccionar Alumno</span>
                </div>

                <div class="p-2">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3 small"></div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small text-uppercase fw-bold">Buscar por Nombre</label>
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-search"></i></span>
                            <input type="text" id="buscadorSocio" class="form-control bg-dark border-secondary text-white" placeholder="Escribe para filtrar..." autocomplete="off" autofocus>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="SocioId" class="form-label text-secondary small text-uppercase fw-bold">Listado</label>
                        <select asp-for="SocioId" id="selectSocio" class="form-select bg-dark border-secondary text-white" asp-items="ViewBag.ListaSocios" size="8" style="background-image: none;">
                            <option value="" class="text-muted p-2">-- Seleccione un Alumno --</option>
                        </select>
                        <span asp-validation-for="SocioId" class="text-danger small mt-1 d-block"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function() {
            var $select = $('#selectSocio');
            var $options = $select.find('option');

            $('#buscadorSocio').on('keyup', function() {
                var term = $(this).val().toLowerCase();
                $select.empty();

                var $filtered = $options.filter(function() {
                    return $(this).text().toLowerCase().indexOf(term) > -1 || $(this).val() === "";
                });
                $select.append($filtered);

                // Auto-seleccionar si queda solo 1 (opcional, buena UX)
                if ($filtered.length === 1 && term.length > 2) {
                    $filtered.prop('selected', true);
                }
            });
        });
    </script>
}