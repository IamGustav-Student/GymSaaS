@model IEnumerable<GymSaaS.Application.Rutinas.Queries.GetRutinas.RutinaDto>

@{
    Layout = null;
    ViewData["Title"] = "Mis Rutinas";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>@ViewData["Title"]</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/gymvo-cyberpunk.css" asp-append-version="true" />

    <style>
        body {
            background-color: #050505;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header-nav {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            background: rgba(5, 5, 5, 0.95);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .accordion-item {
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px !important;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .accordion-button {
            background-color: rgba(255, 255, 255, 0.03);
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            border: none;
            padding: 1.25rem;
            box-shadow: none !important;
        }

            .accordion-button:not(.collapsed) {
                background-color: rgba(0, 243, 255, 0.1);
                color: var(--md-sys-color-primary);
                border-bottom: 1px solid rgba(0, 243, 255, 0.2);
            }

            .accordion-button::after {
                filter: invert(1);
                transform: scale(0.8);
            }

            .accordion-button:not(.collapsed)::after {
                filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg);
            }

        .exercise-row {
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

            .exercise-row:last-child {
                border-bottom: none;
            }

        .custom-check {
            width: 24px;
            height: 24px;
            border: 2px solid #6c757d;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

            .custom-check.checked {
                background-color: var(--md-sys-color-secondary);
                border-color: var(--md-sys-color-secondary);
                box-shadow: 0 0 10px var(--md-sys-color-secondary);
            }

            .custom-check i {
                display: none;
                color: #000;
                font-size: 14px;
            }

            .custom-check.checked i {
                display: block;
            }

        /* Estilos del Modal de Video */
        .modal-content-video {
            background-color: #000;
            border: 1px solid var(--md-sys-color-primary);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
            border-radius: 12px;
        }

        .modal-header-video {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
        }
    </style>
</head>
<body>

    <div class="header-nav shadow-sm">
        <a asp-action="Index" class="btn btn-sm btn-outline-light rounded-circle me-3"
           style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-arrow-left"></i>
        </a>
        <h4 class="brand-font text-white m-0">Mis Entrenamientos</h4>
    </div>

    <div class="container px-3 py-3">

        @if (!Model.Any())
        {
            <div class="text-center py-5 mt-4">
                <div class="glass-panel p-4">
                    <i class="bi bi-journal-x text-secondary fs-1 d-block mb-3"></i>
                    <h5 class="text-white brand-font">Sin rutinas asignadas</h5>
                    <p class="text-secondary small mb-0">Tu coach aún no ha cargado tu plan de entrenamiento.</p>
                </div>
            </div>
        }
        else
        {
            <p class="text-secondary small mb-4 px-1">Toca un día para ver los ejercicios.</p>

            <div class="accordion" id="rutinasAccordion">
                @foreach (var rutina in Model)
                {
                    <div class="accordion-item glass-panel p-0">
                        <h2 class="accordion-header" id="heading-@rutina.Id">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@rutina.Id">
                                @rutina.Nombre
                            </button>
                        </h2>
                        <div id="collapse-@rutina.Id" class="accordion-collapse collapse" data-bs-parent="#rutinasAccordion">
                            <div class="accordion-body p-0">

                                @if (rutina.Ejercicios != null && rutina.Ejercicios.Any())
                                {
                                    @foreach (var ejercicio in rutina.Ejercicios)
                                    {
                                        <div class="exercise-row">
                                            <div class="d-flex align-items-center gap-3" style="flex: 1;">
                                                <div class="custom-check" onclick="toggleCheck(this)">
                                                    <i class="bi bi-check-lg fw-bold"></i>
                                                </div>

                                                <div style="min-width: 0;">
                                                    <span class="text-white fw-bold d-block text-truncate">@ejercicio.EjercicioNombre</span>
                                                    <div class="d-flex align-items-center gap-2 mt-1">
                                                        <span class="badge bg-dark border border-secondary text-secondary" style="font-size: 0.7rem;">@ejercicio.Series x @ejercicio.Repeticiones</span>
                                                        @if (!string.IsNullOrEmpty(ejercicio.PesoSugerido))
                                                        {
                                                            <span class="text-warning small fw-bold"><i class="bi bi-lightning-fill"></i> @ejercicio.PesoSugerido</span>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(ejercicio.Notas))
                                                    {
                                                        <small class="text-muted d-block mt-1 fst-italic text-truncate">"@ejercicio.Notas"</small>
                                                    }
                                                </div>
                                            </div>

                                            <div class="ms-2">
                                                @if (!string.IsNullOrEmpty(ejercicio.VideoUrl))
                                                {
                                                    // Cambiamos el href por un onclick que llama a nuestra función JS
                                                    <button type="button" class="btn btn-sm btn-link text-danger hover-glow p-0"
                                                            title="Ver técnica"
                                                            onclick="verVideo('@ejercicio.VideoUrl')">
                                                        <i class="bi bi-play-circle-fill fs-2"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <span class="text-muted opacity-25 p-0">
                                                        <i class="bi bi-play-circle fs-2"></i>
                                                    </span>
                                                }
                                            </div>

                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="p-4 text-center text-muted small">
                                        Sin ejercicios cargados.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-content-video">
                <div class="modal-header modal-header-video justify-content-end">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 bg-black">
                    <div class="ratio ratio-16x9">
                        <iframe id="videoFrame" src="" allow="autoplay; fullscreen" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Checkbox visual
        function toggleCheck(element) {
            element.classList.toggle('checked');
        }

        // Lógica del Video Modal
        function verVideo(url) {
            var videoId = "";
            var embedUrl = "";

            // 1. Intentar extraer ID de YouTube (soporta shorts, watch, youtu.be)
            // Regex mágica para detectar formatos de YT
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            var match = url.match(regExp);

            if (match && match[2].length === 11) {
                videoId = match[2];
                // Construimos url embed con autoplay
                embedUrl = "https://www.youtube.com/embed/" + videoId + "?autoplay=1&rel=0";

                // Asignamos al iframe y abrimos modal
                document.getElementById('videoFrame').src = embedUrl;
                var myModal = new bootstrap.Modal(document.getElementById('videoModal'));
                myModal.show();
            } else {
                // Fallback: Si no es YouTube (ej: Instagram, Vimeo) o no pudimos sacar el ID,
                // lo abrimos en pestaña nueva como antes para no romper la UX.
                window.open(url, '_blank');
            }
        }

        // Limpiar video al cerrar modal (Importante para que no siga el audio)
        var videoModal = document.getElementById('videoModal');
        videoModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('videoFrame').src = "";
        });
    </script>

</body>
</html>